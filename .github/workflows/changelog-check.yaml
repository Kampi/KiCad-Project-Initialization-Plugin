name: Changelog Check

on:
  pull_request:
    paths:
      - 'CHANGELOG.md'
  push:
    branches:
      - main
      - master
    paths:
      - 'CHANGELOG.md'

env:
  # Master branch (main or master)
  master_branch: main

jobs:
  validate-changelog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Changelog Format
        shell: bash
        run: |
          CHANGELOG_FILE="CHANGELOG.md"
          
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "Error: CHANGELOG.md not found"
            exit 1
          fi
          
          echo "Validating CHANGELOG.md format..."
          
          # Check if [Unreleased] section exists
          if ! grep -q '\[Unreleased\]' "$CHANGELOG_FILE"; then
            echo "Error: [Unreleased] section not found in CHANGELOG.md"
            exit 1
          fi
          
          # Extract [Unreleased] section content
          UNRELEASED_CONTENT=$(awk '/\[Unreleased\]/,/^## \[/' "$CHANGELOG_FILE" | sed '1d;$d')
          
          if [ -z "$UNRELEASED_CONTENT" ]; then
            echo "Warning: [Unreleased] section is empty"
            exit 0
          fi
          
          echo "Checking [Unreleased] section content..."
          
          # Valid section headers
          VALID_SECTIONS=("### Added" "### Changed" "### Fixed" "### Removed")
          
          # Check for valid section headers
          FOUND_SECTIONS=false
          for section in "${VALID_SECTIONS[@]}"; do
            if echo "$UNRELEASED_CONTENT" | grep -q "^$section"; then
              FOUND_SECTIONS=true
              echo "✓ Found section: $section"
            fi
          done
          
          if [ "$FOUND_SECTIONS" = false ]; then
            echo "Error: No valid sections found in [Unreleased]"
            echo "Expected sections: Added, Changed, Fixed, Removed"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "Changelog validation PASSED"
          echo "=========================================="
          echo "CHANGELOG.md is properly formatted"

      - name: Check for duplicate issue numbers
        shell: bash
        run: |
          CHANGELOG_FILE="CHANGELOG.md"
          
          echo "Checking for duplicate issue numbers in [Unreleased] section..."
          
          # Extract issue numbers from [Unreleased] section
          UNRELEASED_CONTENT=$(awk '/\[Unreleased\]/,/^## \[/' "$CHANGELOG_FILE" | sed '1d;$d')
          
          if [ -z "$UNRELEASED_CONTENT" ]; then
            echo "No content to check"
            exit 0
          fi
          
          # Extract all issue numbers
          ISSUE_NUMBERS=$(echo "$UNRELEASED_CONTENT" | grep -oP '\(#\K[0-9]+(?=\))' || true)
          
          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "No issue numbers found"
            exit 0
          fi
          
          # Check for duplicates
          DUPLICATES=$(echo "$ISSUE_NUMBERS" | sort | uniq -d)
          
          if [ -n "$DUPLICATES" ]; then
            echo "Warning: Duplicate issue numbers found in [Unreleased] section:"
            echo "$DUPLICATES" | while read -r issue; do
              echo "  - Issue #$issue appears multiple times"
            done
            echo ""
            echo "This is not an error, but you may want to review if this is intentional"
          else
            echo "✓ No duplicate issue numbers found"
          fi
